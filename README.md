# virtualMarker
determine the virtual marker position from the side bending vision edge map

[목적]이 프로그램은 OLED 패널의 PCBL부분의 Bending 공정에서 옆부분을 봤을때 읽을 수 있는 윤곽선에서 항상 일정한 기준점을 설정하기 위한 프로그램으로 여러가지 전략을 통해 정확한 기준점을 찾는다.
그 다음 정확한 기준점을 바탕으로 원하는 곡선부분을 특정하고 그 곡선의 점들에 순서번호를 부여한다.

전략 1. 가장 가까운 쌍둥이 곡선 찾기

1. 주어진 좌표 txt 파일을 읽고, 연결된 선들중 가장 길이가 긴 두개의 선을 찾는다.
2. 두개의 선 중 더 긴부분이 LC 짧은 부분은 SC로 명명한다.
3. 사전에 설정된 패널의 추정길이값=PBL값을 사용자에게 받는다.
4. PBL값이 정해지면 LC의 연결된 선에서 PBL값만큼의 부분선이 선택되고 SC의 연결된 선에서 PBL값만큼의 부분선이 선택되었을때 두 부분선 사이의 거리가 가장 가까워지는 경우의 수를 찾는다.
5. 이때 각 부분선을 쌍둥이 곡선으로 정의하고 해당 부분선들의 좌표값을 저장한다.

전략 2. 거북이 머리 더듬기

1. OLED 패널의 PCBL부분의 Bending 공정에서 옆부분을 봤을때 읽을 수 있는 윤곽선 이미지에서 추출된 주어진 점들의 좌표값들이 들어있는 txt 파일을 읽고, 연결된 선들중 가장 길이가 긴 두개의 선을 찾는다.
2. GUI를 통해 사용자에게 설정값을 받는다. 사용자에게 반드시 받아야 하는 설정값의 기호는 FH(Forehead), UH(Upperhead), SX(ShiftX), SY(ShiftY), PBL(Panel bending length) 이다 
3. 두 선중에서 y축 방향에서 가장 아래에 있는 점 두개 중 더 아래에 있는 점을 포함하고 있는 선이 거북이 선이다.
4. 거북이 선에서 먼저 아래쪽 시작점을 찾고 거북이 선 시작점, TLSP(Turtle line starting point)로 명명하고 x,y축 좌표를 저장해라. 거북이 선의 두 끝점 중에서 더 아래에 있는 끝점이 시작점이다.
5. 거북이 선의 시작점에서부터 반대쪽으로 순서대로 가장 가까운 부분부터 순서대로 선을 읽어나간다. 선을 읽어나가다가 처음으로 y축에 평행한 FH(사용자에게 받아야 하는 픽셀 길이값) 픽셀 이상의 직선을 만나는 경우 이 직선을 거북이 앞머리끝으로 명명하고 연결된 직선의 좌표를 저장한다.
6. 거북이 앞머리끝을 지나서 계속 선을 읽어나간다. 계속 선을 읽어나가다가 처음으로 x축에 평행한 UH(사용자에게 받아야 하는 픽셀 길이값) 팍샐 이상의 직선을 만나는 경우 이 직선을 거북이 윗머리끝으로 명명하고 연결된 직선의 좌표를 저장한다.
7. 거북이 앞머리끝 직선의 x축값과 거북이 윗머리끝 직선의 y축 값을 가지는 점을 가상마커 Mv로 명명하고 값을 저장한다.
8. 시작시 사용자에게 받은 SX와 SY값을 이용한다. 가상마커 Mv의 좌표에서 x축으로 SX만큼 y축으로 SY 만큼 평행이동했을때의 점과 가장 가까운 거북이 선의 점 좌표점을 벤딩이 시작되는 시작점인 BSP(bending starting point)으로 명명한다.
9. BSP 점에서부터 시작해서 거북이 선 시작점(TLSP)으로 이어지는 방향의 반대방향으로 거북이 선을 따라가면서 각 점들에 순서번호를 부여한다. 순서번호는 1부터 PBL 값까지 이어지며, PBL값까지 순서번호를 부여하고 나면 끝난다.
10. 순서번호가 부여된 점들을 따로 txt 파일로 저장하고, txt 파일의 좌표값들을 화면에 이미지로 시작화하여 보여준다. 각 점들의 x,y 좌표값을 그대로 이용하고, 순서번호는 색상을 통해 시각화하여 2차원 평면에 모두 나타낸다. 시각화한 이미지는 이미지 파일로 저장한다.

## 구현 개요 (전략 2 중심, 오프라인 윈도우 프로그램)

- **언어/환경**: Python 3, 오프라인 실행 가능한 윈도우용 GUI 프로그램
- **GUI 라이브러리**: PySide6 (Qt for Python)
- **시각화**: matplotlib
- **파일 처리**:
  - TXT 파일을 최대 500개까지 한 번에 선택 가능
  - 각 TXT 파일에 대해 전략 2 알고리즘을 적용하여 결과를 개별적으로 저장
  - 결과로:
    - `_bending_points.txt` (BSP에서 시작해 1~PBL까지 순서번호가 부여된 점)
    - `_visualization.png` (곡선 및 인덱스를 색상으로 표현한 이미지)
    를 같은 폴더에 생성

### TXT 입력 포맷 가정

전략 2 입력은 “선(폴리라인)”이 아니라, **윤곽선(edge map)에서 추출된 점(dot)들의 집합**이다.
즉 TXT에는 점들의 좌표만 있으며, **특정 선을 파일에서 직접 정의하지 않는다.**

- **한 줄에 한 점**: `x,y` 또는 `x y`
- `#` 로 시작하는 줄은 **주석**으로 무시한다.
- 빈 줄은 있어도 무방하나, **빈 줄로 선이 분리된다고 가정하지 않는다.**

예시 (실제 포맷):

```text
# x,y
1685,908
1686,908
1687,908
```

#### “선”과 “직선”의 정의 (중요)

- **선(line)**: 점들이 **인접(가로/세로/대각)** 한 관계로 이어져 하나의 연결 집합을 이룰 때, 그 연결 집합(connected component)을 “선”으로 정의한다.
  - 인접 정의: 8-이웃(8-neighborhood) \((\Delta x,\Delta y)\in\{(-1,-1),(-1,0),..., (1,1)\}\setminus(0,0)\)
- **직선(straight)**: 한 선을 따라가면서, 점들이
  - 가로(예: \((+1,0)\) 반복),
  - 세로(예: \((0,+1)\) 반복),
  - 또는 대각(예: \((+1,+1)\) 반복)
  처럼 **한 방향으로만 연속**으로 이어진 최대 구간을 직선으로 정의한다.

### 전략 2 구현에서의 주요 해석

- 좌표계는 일반적인 이미지 좌표계처럼 \(y\) 값이 **클수록 아래쪽**이라고 가정하였다.
- TXT의 점 집합으로부터 8-이웃 연결성으로 “선(connected component)”들을 복원한다.
- "연결된 선들중 가장 길이가 긴 두개의 선"은, 복원된 선들 중에서 **점 개수(= 길이 근사)** 가 큰 상위 2개를 의미한다고 해석한다. (데이터가 dot 기반이므로 길이 합 대신 점 개수를 기본 길이로 사용)
- 거북이 선(turtle line)은 상위 2개 선 중에서, **가장 아래(y가 최대)** 인 점을 포함하는 선으로 정의한다.
- TLSP는 거북이 선에서 **끝점(endpoint)** 중 더 아래에 있는 끝점으로 정의한다.
  - 끝점(endpoint): 해당 점과 인접한 점의 개수가 1개인 점(차수 1)  
- “선을 읽어나간다”는 의미는, 거북이 선을 TLSP에서 시작해 연결을 따라가며 **점의 순서를 복원(경로화)** 하는 것으로 해석한다.
- 거북이 앞머리끝/윗머리끝은 “세그먼트(연속 방향 직선)” 기반으로 탐색한다.
  - 앞머리끝: TLSP에서 출발해 경로를 따라가다 처음으로 만나는, **세로 방향 직선** 중 길이 ≥ FH 인 구간
  - 윗머리끝: 앞머리끝 이후 계속 경로를 따라가다 처음으로 만나는, **가로 방향 직선** 중 길이 ≥ UH 인 구간
- 가상 마커 \(Mv\) 는:
  - x좌표: 거북이 앞머리끝 “직선 구간”의 대표 x (예: 구간 내 점들의 x 평균)
  - y좌표: 거북이 윗머리끝 “직선 구간”의 대표 y (예: 구간 내 점들의 y 평균)
  의 조합으로 정의하였다.
- SX, SY는 가상 마커 \(Mv\) 를 평행 이동할 거리로,
  - \(Mv_{\text{shifted}} = (Mv_x + SX, Mv_y + SY)\)
  로 계산하였다.
- BSP는 거북이 선의 점들 중에서 \(Mv_{\text{shifted}}\) 와의 **유클리드 거리**가 가장 가까운 점으로 정의하였다.
- BSP에서부터 **거북이 선 시작점(TLSP)으로 이어지는 방향의 반대 방향**으로 거북이 선 경로를 따라가며, PBL개의 점을 순서대로 선택해 번호(순서)를 부여한다.
  - 저장 파일에는 인덱스를 명시적으로 기록하며, 순서번호는 1..PBL로 부여된다.

### ver5 유지보수 기준 (현재 버전 해석)

- **해석 타당성**: 현재 버전은 점 기반 edge map에서 전략 2를 안정적으로 수행하며, TLSP/FH/UH/Mv/BSP/샘플링 흐름을 일관되게 유지한다.
- **운영 로그 권장**: 장애 분석 시 최소한 아래 값을 확인한다.
  - 읽은 점 개수
  - 거북이 선 경로 길이
  - FH/UH 검출 점 개수
  - Mv/BSP 좌표
- **결과 데이터의 인덱스 활용**: 출력 TXT의 `index` 컬럼은 영상 연속 프레임에서 bending trajectory의 motion 변화를 비교하는 기본 키로 사용한다.
- **시각화 원칙**:
  - 원본 edge는 얇고 투명하게, 결과 경로는 고대비로 표시
  - bending points는 스펙트럼 colormap으로 순서를 직관적으로 표현
  - TLSP/BSP/Mv/Mv'는 서로 다른 도형과 tag로 구분

### ver6 GUI/UX 업데이트 (배포 기준)

- **전체 GUI 영어화**: 버튼/레이블/로그/팝업 메시지를 모두 영어로 통일하여 글로벌 운영 환경에서 바로 사용 가능하게 했다.
- **파라미터 이해도 강화**:
  - FH/UH/SX/SY/PBL/Sample Step에 tooltip 설명을 추가했다.
  - GUI 내 `How Strategy 2 Works` 패널에서 알고리즘 흐름과 출력 포맷을 단계별로 설명한다.
- **출력 폴더 지정 기능**:
  - 사용자가 별도 Output Directory를 지정할 수 있다.
  - 비워두면 기존처럼 입력 파일과 같은 폴더에 저장한다.
- **전문가 테마 적용**:
  - 일관된 다크 테마, 고가독성 대비, 명확한 그룹 박스와 컨트롤 스타일로 생산 환경 UI 품질을 개선했다.
- **버전 번호**: 당시 배포 버전은 `v6.0.0` 이다.

### ver9 최종 출시 업데이트

- **가장 긴 선 2개 시각화 보정**:
  - 거북이 선 외에 원본 입력 기준 상위 2개 connected component를 회색으로 함께 표시한다.
  - 선이 짧게 잘리는 문제를 줄이기 위해 원본 점군 자체를 사용해 길이를 보존한다.
- **Mv' / BSP 겹침 처리**:
  - 두 점이 가까울 때 라벨 오프셋을 자동 분리하여 텍스트/좌표 가독성을 확보한다.
- **Auto diagnostics 심각도 컬러 로그**:
  - INFO / WARNING / CRITICAL 단계로 로그를 색상 구분한다.
  - 즉시 조치가 필요한 메시지는 빨간색(CRITICAL)으로 강조한다.
  - CRITICAL 진단 포인트는 시각화 이미지에도 빨간 마커로 함께 표시한다.
- **출력 경로 기본값 변경**:
  - 기본 output 경로를 실행 파일(EXE) 위치 기준 `output` 폴더로 설정한다.
- **Preview 고도화**:
  - 최근 시각화 이미지를 최대 100장까지 GUI에서 확인할 수 있다.
  - 프리뷰 타일 크기를 키워 세부 상태를 쉽게 확인하도록 개선했다.
- **드래그 리사이즈 UX**:
  - UI 영역을 `QSplitter` 기반으로 구성해 사용자가 항목별 영역을 드래그로 확대/축소 가능하다.
- **EXE 이름 오타 수정**:
  - 빌드/아티팩트 이름을 `virtualmarker_app`으로 통일했다.
- **버전 번호**: 최종 출시 버전은 `v9.0.0` 이다.

### ver10 업데이트 방향 반영

- **Preview 가시성/확대 개선**:
  - Last visualization preview에서 타일 렌더링 구조를 수정해 이미지가 안정적으로 보이도록 개선했다.
  - 각 프리뷰 이미지는 클릭 시 확대 다이얼로그로 확인할 수 있다.
- **Mv' / BSP 진단 정책 보정**:
  - Mv'와 BSP가 가까운 경우는 정상 동작으로 간주하며 경고/치명 메시지를 출력하지 않는다.
  - 두 점 간 거리가 의도 범위를 벗어나 멀어질 때만 WARNING/CRITICAL 진단을 출력한다.
- **시각화 정밀도 강화**:
  - bending point 크기를 기존 대비 1/10 수준으로 축소해 세밀 관찰성을 높였다.
  - 주요 선/마커를 더 얇고 반투명하게 조정하여 중첩 영역 가림 현상을 줄였다.
  - 5픽셀 간격의 얇은 회색 그리드를 추가해 거리 파악성을 높였다.
- **핵심 좌표/오차 정보 표시**:
  - 이미지 내에 Mv, Mv', BSP 좌표를 표시한다.
  - Mv'→BSP의 `dx, dy, distance(px)`를 함께 표기해 초기 오차를 즉시 확인 가능하다.
- **버전 번호**: 현재 최종 배포 버전은 `v10.0.0` 이다.

### ver11 업데이트 반영

- **X축 숫자 겹침 해결**:
  - x축 major tick을 자동 밀도 제한(`MaxNLocator`)으로 제어한다.
  - 라벨을 30도 회전 + 우측 정렬해 긴 좌표 범위에서도 겹침을 줄인다.
- **거북이 선 선택 로직 보정**:
  - `pick_two_longest_lines`: 가장 긴 두 선만 정확히 선택하도록 합치기 휴리스틱 제거.
  - `find_turtle_line`: 각 component의 최하단 점(y 최대)을 명시적으로 비교하여 선택.
  - 세 번째로 긴 선이나 짧은 선이 잘못 선택되는 문제 해결.
- **버전 번호**: 현재 최종 배포 버전은 `v11.0.0` 이다.

### Developer Handoff (for next AI model)

다음 모델이 바로 이어서 개발할 수 있도록 현재 동작과 핵심 해석을 정리한다.

- **Core flow (`strategy2.py`)**
  - 입력 TXT 점군을 8-이웃 connected component로 복원.
  - 가장 긴 선 2개만 정확히 선택 (`pick_two_longest_lines`).
  - 두 선 중 각각의 최하단 점(y 최대)을 비교하여 y값이 더 큰 선을 거북이 선으로 선택 (`find_turtle_line`).
  - TLSP, FH, UH를 순차 검출하고 Mv / Mv' / BSP 계산.
  - BSP에서 반대 방향 샘플링으로 `x,y,index` 출력 생성.
- **Diagnostics policy**
  - `Mv'`와 `BSP`는 원래 가깝게 맞추는 것이 정상.
  - 진단은 **가까울 때가 아니라 멀어질 때**만 WARNING/CRITICAL을 출력.
  - CRITICAL 진단은 시각화 이미지에도 issue point로 표시.
- **Visualization policy (`visualization.py`)**
  - 원본 점군 + longest two components + turtle path를 중첩 시각화.
  - 마커는 반투명으로 설정해 가림 현상을 줄임.
  - 5px 간격 보조 그리드(minor) + major grid를 함께 사용.
  - 이미지 내부에 `Mv`, `Mv'`, `BSP` 좌표와 `dx, dy, dist(px)` 오차 정보를 표시.
- **GUI policy (`app.py`)**
  - `QSplitter` 기반 드래그 리사이즈 UI.
  - Last visualization preview는 최대 100장 유지.
  - 프리뷰 이미지는 클릭 시 확대 다이얼로그로 확인 가능.
  - 기본 output 경로는 실행파일 기준 `output/`.
- **Release/build naming**
  - EXE 이름/아티팩트 이름은 `virtualmarker_app` 계열로 통일.
  - 워크플로우: `.github/workflows/windows-build.yml`.

### 정밀 제어용 파라미터

GUI에서 아래 파라미터들을 조정하여 실제 공정 조건에 맞게 전략 2를 튜닝할 수 있다.

- **FH**: 세로 직선 최소 길이 (픽셀 단위)
- **UH**: 가로 직선 최소 길이 (픽셀 단위)
- **SX**: 가상 마커의 x축 평행 이동량
- **SY**: 가상 마커의 y축 평행 이동량
- **PBL**: BSP에서부터 생성할 bending 포인트 개수
- **세로 각도 허용 (deg)**:
  - FH 세그먼트를 찾을 때, 이상적인 세로(완전 y축 평행)에서 얼마나 각도 차이를 허용할지 설정
  - 기본값 5도 (±5도 안에 있으면 세로로 인정)
- **가로 각도 허용 (deg)**:
  - UH 세그먼트를 찾을 때, 이상적인 가로(완전 x축 평행)에서 얼마나 각도 차이를 허용할지 설정
  - 기본값 5도 (±5도 안에 있으면 가로로 인정)
- **샘플 간 거리 (pixel)**:
  - BSP에서 거북이 선을 따라갈 때, 인접 포인트 간 거리를 픽셀 단위로 설정
  - PBL과 함께 실제 물리 거리(총 bending 길이)를 조정하는 데 사용 가능

### 결과 파일(TXT) 저장 포맷 (중요)

전략 2 실행 결과로 저장되는 bending 포인트 TXT는 **`x,y,index` 포맷**을 따른다.

- 첫 줄에 권장 주석:
  - `# x,y,index`
- 이후 줄마다 한 점:
  - `x,y,index`
- `index`는 1..PBL의 순번을 명시적으로 저장한다.
- 줄 순서와 `index`는 동일해야 하며, 후처리에서는 `index`를 기준으로 모션 분석을 수행한다.

예시:

```text
# x,y,index
1685,908,1
1686,908,2
...
```

### 예시 TXT 데이터 생성

`vertualmarker/data_generator.py` 모듈에서 실제 OLED 패널 PCBL 측면 윤곽과 유사한 2개의 긴 곡선을 합성한다.

- 특징:
  - 하나는 아래쪽 거북이 선, 다른 하나는 그 위쪽에 거의 평행한 선
  - 중앙 부근에 부드러운 굽힘(bending) 구간이 있고, 양쪽은 거의 직선
  - 약간의 랜덤 노이즈를 추가하여 실제 edge map과 비슷한 거칠기를 부여
- GUI에서 `예시 TXT 생성...` 버튼을 눌러:
  - 저장 위치를 지정하면 위 형식에 맞는 TXT가 자동 생성된다.
  - 생성된 파일은 자동으로 파일 리스트에 추가되므로 곧바로 전략 2를 테스트할 수 있다.

### 프로그램 실행 방법 (윈도우, 오프라인)

1. Python 3.10 이상이 설치되어 있다고 가정한다.
2. 이 리포지토리 루트에서 다음 명령으로 의존성 설치:

```bash
pip install -r requirements.txt
```

3. GUI 프로그램 실행:

```bash
python app.py
```

4. 화면에서:
   - `Add Files...` 버튼으로 TXT 파일들을 선택하거나, `Generate Example TXT...` 으로 샘플 데이터를 생성한다. (최대 500개)
   - Output Directory 기본값은 실행 파일 위치의 `output` 폴더이며, 필요 시 변경 가능하다.
   - 전략 2 파라미터를 입력하고, `How Strategy 2 Works` 패널을 참고해 설정을 조정한다.
   - `Run Processing` 버튼을 누르면,
     - 각 입력 TXT 파일 옆에
       - `<원본>_bending_points.txt`
       - `<원본>_visualization.png`
       가 생성된다.
   - 하단 `Execution Log`에서 처리 성공/실패 메시지와 오류 내용을 확인할 수 있다.

### 윈도우용 EXE / 배치 빌드 (GitHub Actions)

로컬 또는 GitHub Actions에서 PyInstaller를 이용해 윈도우용 EXE를 만들 수 있다.

- 로컬 빌드용 배치 파일: `build_windows.bat`
  - PyInstaller가 설치되어 있다고 가정하고, `dist/virtualmarker_app.exe` 를 생성한다.
- GitHub Actions 워크플로우: `.github/workflows/windows-build.yml`
  - `windows-latest` 환경에서 Python을 설치하고, 의존성을 설치한 뒤 PyInstaller로 EXE를 빌드한다.
  - 빌드된 EXE는 GitHub Actions의 아티팩트로 업로드되며, 웹에서 바로 다운로드할 수 있다.
