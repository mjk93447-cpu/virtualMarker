# vertualMarker
determine the virtual marker position from the side bending vision edge map

[목적]이 프로그램은 OLED 패널의 PCBL부분의 Bending 공정에서 옆부분을 봤을때 읽을 수 있는 윤곽선에서 항상 일정한 기준점을 설정하기 위한 프로그램으로 여러가지 전략을 통해 정확한 기준점을 찾는다.
그 다음 정확한 기준점을 바탕으로 원하는 곡선부분을 특정하고 그 곡선의 점들에 순서번호를 부여한다.

전략 1. 가장 가까운 쌍둥이 곡선 찾기

1. 주어진 좌표 txt 파일을 읽고, 연결된 선들중 가장 길이가 긴 두개의 선을 찾는다.
2. 두개의 선 중 더 긴부분이 LC 짧은 부분은 SC로 명명한다.
3. 사전에 설정된 패널의 추정길이값=PBL값을 사용자에게 받는다.
4. PBL값이 정해지면 LC의 연결된 선에서 PBL값만큼의 부분선이 선택되고 SC의 연결된 선에서 PBL값만큼의 부분선이 선택되었을때 두 부분선 사이의 거리가 가장 가까워지는 경우의 수를 찾는다.
5. 이때 각 부분선을 쌍둥이 곡선으로 정의하고 해당 부분선들의 좌표값을 저장한다.

전략 2. 거북이 머리 더듬기

1. OLED 패널의 PCBL부분의 Bending 공정에서 옆부분을 봤을때 읽을 수 있는 윤곽선 이미지에서 추출된 주어진 점들의 좌표값들이 들어있는 txt 파일을 읽고, 연결된 선들중 가장 길이가 긴 두개의 선을 찾는다.
2. GUI를 통해 사용자에게 설정값을 받는다. 사용자에게 반드시 받아야 하는 설정값의 기호는 FH(Forehead), UH(Upperhead), SX(ShiftX), SY(ShiftY), PBL(Panel bending length) 이다 
3. 두 선중에서 y축 방향에서 가장 아래에 있는 점 두개 중 더 아래에 있는 점을 포함하고 있는 선이 거북이 선이다.
4. 거북이 선에서 먼저 아래쪽 시작점을 찾고 거북이 선 시작점, TLSP(Turtle line starting point)로 명명하고 x,y축 좌표를 저장해라. 거북이 선의 두 끝점 중에서 더 아래에 있는 끝점이 시작점이다.
5. 거북이 선의 시작점에서부터 반대쪽으로 순서대로 가장 가까운 부분부터 순서대로 선을 읽어나간다. 선을 읽어나가다가 처음으로 y축에 평행한 FH(사용자에게 받아야 하는 픽셀 길이값) 픽셀 이상의 직선을 만나는 경우 이 직선을 거북이 앞머리끝으로 명명하고 연결된 직선의 좌표를 저장한다.
6. 거북이 앞머리끝을 지나서 계속 선을 읽어나간다. 계속 선을 읽어나가다가 처음으로 x축에 평행한 UH(사용자에게 받아야 하는 픽셀 길이값) 팍샐 이상의 직선을 만나는 경우 이 직선을 거북이 윗머리끝으로 명명하고 연결된 직선의 좌표를 저장한다.
7. 거북이 앞머리끝 직선의 x축값과 거북이 윗머리끝 직선의 y축 값을 가지는 점을 가상마커 Mv로 명명하고 값을 저장한다.
8. 시작시 사용자에게 받은 SX와 SY값을 이용한다. 가상마커 Mv의 좌표에서 x축으로 SX만큼 y축으로 SY 만큼 평행이동했을때의 점과 가장 가까운 거북이 선의 점 좌표점을 벤딩이 시작되는 시작점인 BSP(bending starting point)으로 명명한다.
9. BSP 점에서부터 시작해서 거북이 선 시작점(TLSP)으로 이어지는 방향의 반대방향으로 거북이 선을 따라가면서 각 점들에 순서번호를 부여한다. 순서번호는 1부터 PBL 값까지 이어지며, PBL값까지 순서번호를 부여하고 나면 끝난다.
10. 순서번호가 부여된 점들을 따로 txt 파일로 저장하고, txt 파일의 좌표값들을 화면에 이미지로 시작화하여 보여준다. 각 점들의 x,y 좌표값을 그대로 이용하고, 순서번호는 색상을 통해 시각화하여 2차원 평면에 모두 나타낸다. 시각화한 이미지는 이미지 파일로 저장한다.

## 구현 개요 (전략 2 중심, 오프라인 윈도우 프로그램)

- **언어/환경**: Python 3, 오프라인 실행 가능한 윈도우용 GUI 프로그램
- **GUI 라이브러리**: PySide6 (Qt for Python)
- **시각화**: matplotlib
- **파일 처리**:
  - TXT 파일을 최대 500개까지 한 번에 선택 가능
  - 각 TXT 파일에 대해 전략 2 알고리즘을 적용하여 결과를 개별적으로 저장
  - 결과로:
    - `_bending_points.txt` (BSP에서 시작해 1~PBL까지 순서번호가 부여된 점)
    - `_visualization.png` (곡선 및 인덱스를 색상으로 표현한 이미지)
    를 같은 폴더에 생성

### TXT 입력 포맷 가정

전략 2를 구현하기 위해 아래와 같은 **입력 포맷을 가정**하였다. 실제 데이터가 다를 경우 이 포맷에 맞게 변환해야 한다.

- 한 TXT 파일 안에 여러 개의 윤곽선(폴리라인)이 있을 수 있다.
- 각 줄은 `x y` 또는 `x,y` 형식의 두 개 좌표값으로 이루어진다.
- **빈 줄**(공백 또는 아무것도 없는 줄)이 서로 다른 폴리라인을 구분한다.

### 전략 2 구현에서의 주요 해석

- 좌표계는 일반적인 이미지 좌표계처럼 \(y\) 값이 **클수록 아래쪽**이라고 가정하였다.
- TXT 파일에서 추출한 각 빈 줄로 구분된 점들의 집합을 하나의 **연결된 선(폴리라인)** 으로 본다.
- "연결된 선들 중 가장 길이가 긴 두 개의 선"은 각 폴리라인의 길이(연속 점 사이의 거리 합)를 기준으로 상위 2개를 선택한다.
- 거북이 선(turtle line)은 두 폴리라인에서 **가장 아래(y가 최대)** 에 있는 점을 포함하는 폴리라인으로 정의하였다.
- TLSP는 거북이 선의 두 끝점 중에서 **더 아래에 있는 끝점**이 되도록, 필요 시 폴리라인의 순서를 뒤집어서 항상 TLSP가 첫 번째 점이 되도록 정렬하였다.
- 거북이 선의 시작점(TLSP)에서 반대쪽 끝점 방향으로 선분들을 따라가면서, 최초로 만나는 **세로 방향 직선 구간(FH 이상)** 을 거북이 앞머리끝으로 잡았다.
- 그 이후에도 같은 방향으로 계속 진행하면서, 최초로 만나는 **가로 방향 직선 구간(UH 이상)** 을 거북이 윗머리끝으로 잡았다.
- 가상 마커 \(Mv\) 는:
  - x좌표: 거북이 앞머리끝 세그먼트의 중점 x좌표
  - y좌표: 거북이 윗머리끝 세그먼트의 중점 y좌표
  의 조합으로 정의하였다.
- SX, SY는 가상 마커 \(Mv\) 를 평행 이동할 거리로,
  - \(Mv_{\text{shifted}} = (Mv_x + SX, Mv_y + SY)\)
  로 계산하였다.
- BSP는 거북이 선의 점들 중에서 \(Mv_{\text{shifted}}\) 와의 **유클리드 거리**가 가장 가까운 점으로 정의하였다.
- BSP에서부터 **거북이 선 시작점(TLSP)으로 이어지는 방향의 반대 방향**으로 폴리라인을 따라가며, 균일한 거리 간격으로 PBL개의 점을 생성하고 1~PBL의 번호를 부여하였다.

### 정밀 제어용 파라미터

GUI에서 아래 파라미터들을 조정하여 실제 공정 조건에 맞게 전략 2를 튜닝할 수 있다.

- **FH**: 세로 직선 최소 길이 (픽셀 단위)
- **UH**: 가로 직선 최소 길이 (픽셀 단위)
- **SX**: 가상 마커의 x축 평행 이동량
- **SY**: 가상 마커의 y축 평행 이동량
- **PBL**: BSP에서부터 생성할 bending 포인트 개수
- **세로 각도 허용 (deg)**:
  - FH 세그먼트를 찾을 때, 이상적인 세로(완전 y축 평행)에서 얼마나 각도 차이를 허용할지 설정
  - 기본값 5도 (±5도 안에 있으면 세로로 인정)
- **가로 각도 허용 (deg)**:
  - UH 세그먼트를 찾을 때, 이상적인 가로(완전 x축 평행)에서 얼마나 각도 차이를 허용할지 설정
  - 기본값 5도 (±5도 안에 있으면 가로로 인정)
- **샘플 간 거리 (pixel)**:
  - BSP에서 거북이 선을 따라갈 때, 인접 포인트 간 거리를 픽셀 단위로 설정
  - PBL과 함께 실제 물리 거리(총 bending 길이)를 조정하는 데 사용 가능

### 예시 TXT 데이터 생성

`vertualmarker/data_generator.py` 모듈에서 실제 OLED 패널 PCBL 측면 윤곽과 유사한 2개의 긴 곡선을 합성한다.

- 특징:
  - 하나는 아래쪽 거북이 선, 다른 하나는 그 위쪽에 거의 평행한 선
  - 중앙 부근에 부드러운 굽힘(bending) 구간이 있고, 양쪽은 거의 직선
  - 약간의 랜덤 노이즈를 추가하여 실제 edge map과 비슷한 거칠기를 부여
- GUI에서 `예시 TXT 생성...` 버튼을 눌러:
  - 저장 위치를 지정하면 위 형식에 맞는 TXT가 자동 생성된다.
  - 생성된 파일은 자동으로 파일 리스트에 추가되므로 곧바로 전략 2를 테스트할 수 있다.

### 프로그램 실행 방법 (윈도우, 오프라인)

1. Python 3.10 이상이 설치되어 있다고 가정한다.
2. 이 리포지토리 루트에서 다음 명령으로 의존성 설치:

```bash
pip install -r requirements.txt
```

3. GUI 프로그램 실행:

```bash
python app.py
```

4. 화면에서:
   - `파일 추가...` 버튼으로 TXT 파일들을 선택하거나, `예시 TXT 생성...` 으로 샘플 데이터를 생성한다. (최대 500개)
   - 전략 2에 필요한 값들과 각도/샘플링 파라미터를 입력한다.
   - `선택한 파일들 처리 실행` 버튼을 누르면,
     - 각 입력 TXT 파일 옆에
       - `<원본>_bending_points.txt`
       - `<원본>_visualization.png`
       가 생성된다.
   - 하단의 로그 창에서 처리 성공/실패 메시지와 오류 내용을 확인할 수 있다.

### 윈도우용 EXE / 배치 빌드 (GitHub Actions)

로컬 또는 GitHub Actions에서 PyInstaller를 이용해 윈도우용 EXE를 만들 수 있다.

- 로컬 빌드용 배치 파일: `build_windows.bat`
  - PyInstaller가 설치되어 있다고 가정하고, `dist/vertualmarker_app.exe` 를 생성한다.
- GitHub Actions 워크플로우: `.github/workflows/windows-build.yml`
  - `windows-latest` 환경에서 Python을 설치하고, 의존성을 설치한 뒤 PyInstaller로 EXE를 빌드한다.
  - 빌드된 EXE는 GitHub Actions의 아티팩트로 업로드되며, 웹에서 바로 다운로드할 수 있다.
